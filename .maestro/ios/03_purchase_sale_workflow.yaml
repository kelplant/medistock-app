# MediStock iOS - Purchase → Sale Workflow Tests
# Tests the complete FIFO workflow
appId: com.medistock.ios
---

# Setup: Login
- launchApp:
    clearState: true

- waitForAnimationToEnd

- tapOn: "Nom d'utilisateur"
- inputText: "admin"

- tapOn: "Mot de passe"
- inputText: "admin"

- tapOn: "Se connecter"

- waitForAnimationToEnd:
    timeout: 10000

# Verify we're on the home screen
- assertVisible: "MediStock"
- assertVisible: "Opérations"

# ========== STEP 1: Create/verify a site exists ==========
# Scroll and navigate to Administration
- scrollUntilVisible:
    element:
      text: "Administration"
    direction: DOWN

- waitForAnimationToEnd

- tapOn:
    text: "Administration"
    index: 1
    retryTapIfNoChange: true

- waitForAnimationToEnd:
    timeout: 5000

- tapOn:
    text: "Sites"
    retryTapIfNoChange: true

- waitForAnimationToEnd

# If no sites, create one
- runFlow:
    when:
      visible: "Aucun site"
    commands:
      - tapOn:
          text: "Ajouter un site"
          optional: true
      - waitForAnimationToEnd
      - tapOn:
          text: "Nom du site"
      - inputText: "Pharmacie Test iOS"
      - tapOn: "Ajouter"
      - waitForAnimationToEnd

- takeScreenshot: "ios_site_ready"

# Go back to Admin
- back

- waitForAnimationToEnd

# ========== STEP 2: Create/verify a product exists ==========
- tapOn:
    text: "Produits"
    retryTapIfNoChange: true

- waitForAnimationToEnd

# If no products, create one
- runFlow:
    when:
      visible: "Aucun produit"
    commands:
      - tapOn:
          text: ".*Ajouter.*"
          optional: true
      - waitForAnimationToEnd
      - tapOn:
          text: "Nom du produit"
          optional: true
      - inputText: "Paracetamol iOS"
      - tapOn:
          text: ".*Ajouter.*"
          optional: true
      - waitForAnimationToEnd

- takeScreenshot: "ios_product_ready"

# Go back to home
- back
- back

- waitForAnimationToEnd

# ========== STEP 3: Create a Purchase (adds stock) ==========
- tapOn: "Achats"

- waitForAnimationToEnd

# Add new purchase
- tapOn:
    text: ".*Ajouter.*"
    optional: true

- waitForAnimationToEnd

# Fill purchase form
# Select product
- tapOn:
    text: ".*Produit.*"
    optional: true
- tapOn:
    text: ".*Paracetamol.*"
    optional: true

# Enter quantity
- tapOn:
    text: ".*Quantité.*"
    optional: true
- inputText: "100"

# Enter price
- tapOn:
    text: ".*Prix.*achat.*"
    optional: true
- inputText: "5"

# Save purchase
- tapOn:
    text: ".*Enregistrer.*"
    optional: true
- tapOn:
    text: ".*Ajouter.*"
    optional: true

- waitForAnimationToEnd

- takeScreenshot: "ios_purchase_created"

# Go back to home
- back

- waitForAnimationToEnd

# ========== STEP 4: Verify stock ==========
- tapOn: "Stock"

- waitForAnimationToEnd

# Verify product appears with stock
- assertVisible:
    text: ".*Paracetamol.*"
    optional: true

- takeScreenshot: "ios_stock_after_purchase"

# Go back to home
- back

- waitForAnimationToEnd

# ========== STEP 5: Create a Sale (reduces stock via FIFO) ==========
- tapOn: "Ventes"

- waitForAnimationToEnd

# Add new sale
- tapOn:
    text: ".*Ajouter.*"
    optional: true

- waitForAnimationToEnd

# Enter customer
- tapOn:
    text: ".*Client.*"
    optional: true
- inputText: "Patient Test iOS"

# Add product to sale
- tapOn:
    text: ".*Ajouter.*article.*"
    optional: true
- tapOn:
    text: ".*Paracetamol.*"
    optional: true

# Enter quantity
- tapOn:
    text: ".*Quantité.*"
    optional: true
- eraseText: 100
- inputText: "20"

# Validate sale
- tapOn:
    text: ".*Valider.*"
    optional: true
- tapOn:
    text: ".*Enregistrer.*"
    optional: true

- waitForAnimationToEnd

- takeScreenshot: "ios_sale_created"

# Go back to home
- back

- waitForAnimationToEnd

# ========== STEP 6: Verify stock decreased ==========
- tapOn: "Stock"

- waitForAnimationToEnd

# Stock should now show 80 units (100 - 20)
- takeScreenshot: "ios_stock_after_sale"
