# MediStock Android - Transfer Tests
# Tests for transfer functionality including batch picker, stock display, and non-blocking stock
appId: com.medistock
---

# Setup: Login
- launchApp:
    clearState: true

- waitForAnimationToEnd

- tapOn:
    id: "com.medistock:id/editUsername"
- inputText: "admin"

- tapOn:
    id: "com.medistock:id/editPassword"
- inputText: "admin"

- tapOn:
    id: "com.medistock:id/btnLogin"

- waitForAnimationToEnd:
    timeout: 10000

# ========== PREREQUISITE: Create sites ==========
- tapOn:
    text: ".*Administration.*"

- waitForAnimationToEnd

- tapOn:
    text: ".*Site Management.*"

- waitForAnimationToEnd

# Create Site 1
- tapOn:
    id: ".*fab.*"
    optional: true

- waitForAnimationToEnd

- inputText: "Warehouse Central"

- tapOn:
    text: ".*Save.*"
    optional: true

- waitForAnimationToEnd

# Create Site 2
- tapOn:
    id: ".*fab.*"
    optional: true

- waitForAnimationToEnd

- inputText: "Pharmacy Test"

- tapOn:
    text: ".*Save.*"
    optional: true

- waitForAnimationToEnd

- takeScreenshot: "android_transfer_sites_ready"

# Navigate back to home
- back
- waitForAnimationToEnd
- back
- waitForAnimationToEnd

# ========== TEST 1: Navigate to Transfer screen ==========
- tapOn:
    text: ".*Transfer.*"

- waitForAnimationToEnd

- takeScreenshot: "android_transfer_screen"

# ========== TEST 2: Open transfer form and verify elements ==========
- tapOn:
    id: ".*fab.*"
    optional: true

- waitForAnimationToEnd

# Verify from/to site spinners are visible
- assertVisible:
    id: "com.medistock:id/spinnerFromSite"

- assertVisible:
    id: "com.medistock:id/spinnerToSite"

# Verify add product button is visible
- assertVisible:
    id: "com.medistock:id/btnAddProduct"

- takeScreenshot: "android_transfer_form"

# ========== TEST 3: Open add product dialog and verify batch picker ==========
- tapOn:
    id: "com.medistock:id/btnAddProduct"

- waitForAnimationToEnd

# Verify product spinner is visible
- assertVisible:
    id: "com.medistock:id/spinnerProductDialog"

# Verify stock display is visible
- assertVisible:
    id: "com.medistock:id/textAvailableStock"

# Verify quantity field is visible
- assertVisible:
    id: "com.medistock:id/editQuantityDialog"

# Batch spinner should appear when product has batches (initially may be hidden if no batches)
- takeScreenshot: "android_transfer_add_product_dialog"

# ========== TEST 4: Verify batch picker visibility (hidden when no batches) ==========
# The batch label and spinner should be gone when product has no batches
- assertNotVisible:
    id: "com.medistock:id/labelBatchSelection"
    optional: true

- assertNotVisible:
    id: "com.medistock:id/spinnerBatchDialog"
    optional: true

# Expiry warning should not be visible initially
- assertNotVisible:
    id: "com.medistock:id/textBatchExpiryWarning"
    optional: true

- takeScreenshot: "android_transfer_batch_picker_hidden"

# ========== TEST 5: Non-blocking stock - add item with insufficient stock ==========
# Enter a quantity (even if stock is 0, it should still add the item with a warning)
- tapOn:
    id: "com.medistock:id/editQuantityDialog"
- inputText: "100"

# Tap Add button
- tapOn:
    text: ".*Add.*"

- waitForAnimationToEnd

# The item should be added even with insufficient stock (non-blocking behavior)
# A toast warning may appear but the dialog should close and item should be in the list
- takeScreenshot: "android_transfer_non_blocking_stock"

# ========== TEST 6: Verify item was added to the transfer list ==========
# Check if the recycler view has items (the item should appear in the list)
- assertVisible:
    id: "com.medistock:id/recyclerTransferItems"

- takeScreenshot: "android_transfer_item_added"

# Navigate back
- back
- waitForAnimationToEnd
- back
- waitForAnimationToEnd

# Verify we're back on home screen
- assertVisible:
    text: ".*MediStock.*"
    optional: true

- takeScreenshot: "android_transfer_completed"
